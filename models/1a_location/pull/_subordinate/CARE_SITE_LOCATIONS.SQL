-----------------------------------------------
-- CARE_SITE_LOCATIONS
-----------------------------------------------

  {{ config(materialized='ephemeral') }}

SELECT DISTINCT CLARITY_POS.ADDRESS_LINE_1 AS ADDRESS_1
	,CLARITY_POS.ADDRESS_LINE_2 AS ADDRESS_2
	,CLARITY_POS.CITY AS CITY
	,LEFT(ZC_STATE.ABBR, 2) AS STATE
	,LEFT(CLARITY_POS.ZIP, 5) AS ZIP
	,ZC_COUNTY.NAME AS county
	,LEFT(COALESCE(CLARITY_POS.ADDRESS_LINE_1, '') 
		|| COALESCE(CLARITY_POS.ADDRESS_LINE_2, '') 
		|| COALESCE(CLARITY_POS.CITY, '') 
		|| COALESCE(LEFT(ZC_STATE.ABBR, 2), '') 
		|| COALESCE(CLARITY_POS.ZIP, '') 
		|| COALESCE(ZC_COUNTY.COUNTY_C, ''), 50) 
	AS LOCATION_SOURCE_VALUE
	
FROM {{ref('AOU_DRIVER')}} AS AOU
	INNER JOIN {{ source('CLARITY','PAT_ENC')}}	 as PAT_ENC -- SH_CLINICAL_DB_PROD.EPIC_CLARITY_LZ.PAT_ENC
		ON PAT_ENC.PAT_ID = AOU.EPIC_PAT_ID
	INNER JOIN {{ source('CLARITY','CLARITY_DEP')}}	 as CLARITY_DEP -- SH_CLINICAL_DB_PROD.EPIC_CLARITY_LZ.CLARITY_DEP
		ON PAT_ENC.DEPARTMENT_ID = CLARITY_DEP.DEPARTMENT_ID
	INNER JOIN {{ source('CLARITY','CLARITY_POS')}} as CLARITY_POS	-- SH_CLINICAL_DB_PROD.EPIC_CLARITY_LZ.CLARITY_POS 
		ON CLARITY_DEP.REV_LOC_ID = CLARITY_POS.POS_ID
	INNER JOIN {{ source('CLARITY','ZC_STATE')}} 	 as ZC_STATE --SH_CLINICAL_DB_PROD.EPIC_CLARITY_LZ.ZC_STATE
		ON CLARITY_POS.STATE_C = ZC_STATE.STATE_C
	LEFT OUTER JOIN {{ source('CLARITY','ZC_COUNTY')}}	 as ZC_COUNTY -- SH_CLINICAL_DB_PROD.EPIC_CLARITY_LZ.ZC_COUNTY
		ON CLARITY_POS.COUNTY_C = ZC_COUNTY.COUNTY_C