--V_PROVIDER_ALL

{{ config(materialized = 'view') }}

SELECT DISTINCT PROV_ID AS PROVIDER_ID
    ,PROV_NAME AS PROVIDER_NAME
    ,NPI
    ,DEA
    ,COALESCE(SOURCE_TO_CONCEPT_MAP_SPECIALTY.TARGET_CONCEPT_ID, 0) AS SPECIALTY_CONCEPT_ID
    ,COALESCE(MAX(CARE_SITE.CARE_SITE_ID),1) AS CARE_SITE_ID
    ,YEAR(BIRTH_DATE) AS YEAR_OF_BIRTH 
    ,COALESCE(SOURCE_TO_CONCEPT_MAP_GENDER.TARGET_CONCEPT_ID, 0) AS GENDER_CONCEPT_ID
    ,PROV_ID AS PROVIDER_SOURCE_VALUE
    ,PROV_TYPE AS SPECIALTY_SOURCE_VALUE
    ,0 AS SPECIALTY_SOURCE_CONCEPT_ID
    ,CAST (SEX_C AS VARCHAR(1)) || ':' || ZC_SEX_NAME  AS GENDER_SOURCE_VALUE
    ,0 AS GENDER_SOURCE_CONCEPT_ID

FROM  {{ ref('PROVIDER_CLARITY_ALL')}} AS  PROVIDER_CLARITY_ALL

    LEFT OUTER JOIN  {{ source('CDM','SOURCE_TO_CONCEPT_MAP')}} AS SOURCE_TO_CONCEPT_MAP_SPECIALTY
        ON SPECIALTY_C = SOURCE_TO_CONCEPT_MAP_SPECIALTY.SOURCE_CODE
            AND UPPER(SOURCE_TO_CONCEPT_MAP_SPECIALTY.SOURCE_VOCABULARY_ID) = 'SH_SPECIALTY'

    LEFT JOIN  {{ ref('CARE_SITE')}} AS   CARE_SITE
        ON REV_LOC_ID = CARE_SITE.CARE_SITE_ID

    LEFT JOIN {{ source('CDM','SOURCE_TO_CONCEPT_MAP')}}  AS SOURCE_TO_CONCEPT_MAP_GENDER
        ON SEX_C = SOURCE_TO_CONCEPT_MAP_GENDER.SOURCE_CODE
            AND UPPER(SOURCE_TO_CONCEPT_MAP_GENDER.SOURCE_VOCABULARY_ID) = 'SH_GENDER'

GROUP BY
    PROV_ID
    ,PROV_NAME 
    ,NPI 
    ,DEA
    ,COALESCE(SOURCE_TO_CONCEPT_MAP_SPECIALTY.TARGET_CONCEPT_ID, 0) 
    ,YEAR(BIRTH_DATE) 
    ,COALESCE(SOURCE_TO_CONCEPT_MAP_GENDER.TARGET_CONCEPT_ID, 0)
    ,PROV_ID
    ,LEFT(ZC_SPECIALTY_NAME, 50)
    ,CAST( SEX_C AS VARCHAR(1)) || ':' || ZC_SEX_NAME 
    ,PROV_TYPE