version: 2

models:
  - name: VISIT_OCCURRENCE_AMB_F2F
    description: Subordinate view to VISIT_OCCURRENCE holding the AMBULATORY VISITS. 

  - name: VISIT_OCCURRENCE_HSP
    description: Subordinate view to VISIT_OCCURRENCE holding the HOSPITAL VISITS. 

  - name: VISIT_OCCURRENCE
    description: The VISIT_OCCURRENCE table contains Events where Persons engage with the healthcare system for a duration of time. 
    columns: 
      - name: VISIT_OCCURRENCE_ID
        description: unique id
        tests:
          - unique
          - not_null

      - name: PERSON_ID
        tests:
          - not_null    
          - relationships:
              to: ref('PERSON')
              field: PERSON_ID 

      - name: VISIT_CONCEPT_ID
        tests:
          - not_null
          - relationships:
              to: source('CDM','CONCEPT')
              field: CONCEPT_ID   

      - name: VISIT_TYPE_CONCEPT_ID
        tests:
          - not_null
          - relationships:
              to: source('CDM','CONCEPT')
              field: CONCEPT_ID   

      - name: PROVIDER_ID
        tests:
          - not_null:
              config:
                severity: warn
          - relationships:
              to: ref('PROVIDER')
              field: PROVIDER_ID

      - name: CARE_SITE_ID
        tests:
          - not_null:
              config:
                severity: warn
          - relationships:
              to: ref('CARE_SITE')
              field: CARE_SITE_ID          
              
      - name: VISIT_SOURCE_CONCEPT_ID
        description: Not Applicable - Value:0      
        tests:
          - relationships:
              to: source('CDM','CONCEPT')
              field: CONCEPT_ID   
              
      - name: ADMITTING_SOURCE_CONCEPT_ID
        description: Not Applicable - Value:0      
        tests:
          - relationships:
              to: source('CDM','CONCEPT')
              field: CONCEPT_ID   
             
      - name: DISCHARGE_TO_CONCEPT_ID
        description: Not Applicable - Value:0      
        tests:
          - relationships:
              to: source('CDM','CONCEPT')
              field: CONCEPT_ID  


  - name: VISIT_DETAIL
    description: The VISIT_DETAIL table is an optional table used to represents details of each record in the parent VISIT_OCCURRENCE table. 
    columns: 
      - name: VISIT_DETAIL_ID
        tests:
          - unique
          - not_null

      - name: PERSON_ID
        tests:
          - not_null    
          - relationships:
              to: ref('PERSON')
              field: PERSON_ID 

      - name: VISIT_DETAIL_CONCEPT_ID
        tests:
          - not_null
          - relationships:
              to: source('CDM','CONCEPT')
              field: CONCEPT_ID   

      - name: VISIT_DETAIL_TYPE_CONCEPT_ID
        tests:
          - not_null
          - relationships:
              to: source('CDM','CONCEPT')
              field: CONCEPT_ID   

      - name: ATTENDING_PROV
        tests:
          - not_null:
              config:
                severity: warn
          - relationships:
              to: ref('PROVIDER')
              field: PROVIDER_ID

      - name: CARE_SITE_ID
        tests:
          - not_null:
              config:
                severity: warn
          - relationships:
              to: ref('CARE_SITE')
              field: CARE_SITE_ID          
              
      - name: VISIT_DETAIL_SOURCE_CONCEPT_ID
        description: Not Applicable - Value:0      
        tests:
          - accepted_values:
              values:
                - 0

      - name: ADMITTING_SOURCE_CONCEPT_ID
        tests:
          - not_null
          - relationships:
              to: source('CDM','CONCEPT')
              field: CONCEPT_ID   
              
      - name: VISIT_OCCURRENCE_ID
        tests:
          - not_null:
              config:
                severity: error
          - relationships:
              to: ref('VISIT_OCCURRENCE')
              field: VISIT_OCCURRENCE_ID
                      
